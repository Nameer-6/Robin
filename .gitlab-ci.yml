stages:
  - auth
  - test
  - report

variables:
  MAVEN_OPTS: "-Dmaven.repo.local=.m2/repository"
authenticate:
  stage: auth
  image: eclipse-temurin:20-jdk
  before_script:
    - apt-get update && apt-get install -y curl jq
  script:
    - echo "🔑 Fetching Keycloak token..."
    - |
      RESPONSE=$(curl -s -w "\nHTTP_STATUS:%{http_code}" \
        -X POST "https://dev-keycloak.santechture.com/realms/QATAR/protocol/openid-connect/token" \
        -d "grant_type=password" \
        -d "client_id=robin-qtr" \
        -d "client_secret=$KEYCLOAK_CLIENT_SECRET" \
        -d "username=$KEYCLOAK_USERNAME" \
        -d "password=$KEYCLOAK_PASSWORD")

      echo "$RESPONSE" > response.json
      HTTP_STATUS=$(grep "HTTP_STATUS" response.json | cut -d':' -f2)
      TOKEN=$(sed '/HTTP_STATUS/d' response.json | jq -r '.access_token')

      if [ "$HTTP_STATUS" -ne 200 ] || [ -z "$TOKEN" ] || [ "$TOKEN" == "null" ]; then
        echo "❌ Token fetch failed: $RESPONSE"
        exit 1
      else
        echo "✅ Token obtained"
        echo "ACCESS_TOKEN=$TOKEN" > variables.sh
      fi
  artifacts:
    paths:
      - variables.sh
    expire_in: 1 hour
